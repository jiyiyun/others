链路状态路由协议OSPF
---

- 路由信息传递与路由计算分离
- 基于SPF算法
- 以“累计链路开销”作为选路参考值

链路状态link state指路由接口状态。OSPF中路由器某一接口链路状态包含以下信息 1.该接口的IP地址和掩码，带宽，邻居....

OSPF作为链路状态路由协议，不直接传递各路由器的路由表，而是传递链路状态信息，各路由器基于链路状态信息独立计算路由

各路由器各自维护一个链路状态数据库，邻居路由器先同步链路状态数据库，再各自基于SPF(Shortest Path First)算法计算最优路由，从而提高收敛速度

在度量方式上，OSPF将链路带宽作为选路时的参考依据，“累计带宽”比跳数更科学

OSPF工作方式
---

- step 1 邻居建立
-     step2 同步链路状态数据库
-                 step3计算最优路由

OSPF路由计算简化描述为
- 路由器之间发现并建立邻居关系
- 每台路由器产生向邻居泛洪链路状态信息，同时收集来自邻居路由器的信息，完成LSDB(Link State Database)的同步
- 每台路由器基于LSDB通过SPF算法，计算得到一颗以自己为根的SPT(Shortest Path Tree),再以SPT为基础算法去往各邻居连接网络的最优路由，并形成路由表

Router ID 在自治系统中唯一标识一台运行OSPF的路由器，每台运行OSPF的的路由器都有一个Router ID

router ID是一个32位的无符号整数，格式和IP地址一样，router ID 的选举规则如下
- 手动配置OSPF路由器的Router ID
- 如果没有手动设置router ID,则路由器使用loopback接口中最大的IP地址作为Router ID
- 如果没有配置Loopback接口，则使用物理接口中最大的作为Router ID

OSPF路由器Router ID重新配置后，可以通过重置OSPF进程来更新Router ID

发现并建立邻居- Hello报文
---

Hello 报文的作用 1. 邻居发现 自动发现邻居路由器  2. 邻居建立 完成Hello报文中的参数协商，建立邻居关系。 3. 邻居保持 通过keeplive机制，检测邻居运行状态

OSPF路由器之间在交换链路状态信息之前，首先要彼此建立邻居关系，通过Hello报文实现
- OSPF协议通过Hello报文可以让互联的路由器自动发现并建立邻居关系，为后续可达信息的同步做准备
- 在形成邻居关系过程中，路由器通过hello报文完成一些参数的协商
- 邻居关系建立之后，周期性的hello报文发送还可以实现邻居保持的功能，在一定时间内没有收到hello报文，则会中断路由器间的OSPF邻居关系

OSPF邻居建立过程
```txt
Router ID 1.1.1.1             Router ID 2.2.2.2
           |                               |
Down       |     -------------------->     | Down >init
Down >Init |    <---------------------     | Init
Init>2-way |    <---------------------     | Init
2-way      |     -------------------->     | Init > 2-way
```
- Down: 这是邻居初始状态，表示从没从邻居收到任何信息
- Init: 在此状态下，路由器已经从邻居收到Hello报文，但是自己的Router ID不在所收到的Hello报文的邻居列表中，表示未与邻居建立双向通信关系
- 2-way：在此功能下，路由器发现自己的Router ID存在于收到的Hello报文的邻居列表中，确认可以双向通信

因为邻居是未知的，所以Hello报文的目的地址不是某个特定的单播地址。邻居从无到有，OSPF采用组播形式发送Hello报文(224.0.0.5),对于不支持组播的网络，OSPF怎么发现邻居呢？

OSPF支持通过单播方式建立邻居关系；对于不支持组播的网络可以通过手动配置实现邻居发现与维护

当网络越来越大或者设备频繁更新，OSPF，路由器需要更改静态配置

链路状态信息
---

链路状态信息包括 链路类型；接口IP地址及掩码；链路上所连接的邻居路由器；链路的带宽(开销cost)

OSPF路由器同步的是最原始的链路状态信息，而且对于邻居路由器发来的链路状态信息，仅做转发，最终所有路由器都拥有一份相同完整的原始链路状态信息

每一台运行OSPF协议的路由器描述信息中都应该包括链路类型、接口IP地址及掩码、链路上的邻居、链路开销等信息





